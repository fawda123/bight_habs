---
output: 
  bookdown::html_document2:
    code_folding: hide
---

# Exploration of DA Bight dataset {.tabset}

```{r message = F, warning = F, results = 'hide'}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, fig.path = 'figs/')

library(tidyverse)
library(sf)
library(mapview)
library(patchwork)
library(lubridate)

prj <- 4326 # wgs84

source('R/funcs.R')

pbase <- theme_bw(base_family = 'serif', base_size = 14) +
  theme(
    strip.background = element_blank(), 
    legend.position = 'top', 
    legend.title = element_blank()
  )

data(wqdat)

# all wq data as sf
wqdatgeo <- wqdat %>% 
  filter(!is.na(Lat)) %>% 
  st_as_sf(., coords = c('Long', 'Lat'), crs = prj)

# caron dataset
jsdat <- wqdat %>% 
  select(Year, Month, `Full Date`, `Project ID`, `Station ID`, Depth, `Depth Category`, `Lat`, `Long`, `DA (ng/mL)`, `PN cells (cells/L)`, `Chl a (ug/L)`, Temp, Salinity, `NO2+NO3`) %>% 
  filter(grepl('^Schnetzer|^ECOHAB|^B08|^SCCOOS|^OCSC', `Project ID`)) %>% 
  filter(!grepl('^Santa\\sMonica\\sPier|^Newport', `Station ID`)) %>% 
  filter(Long > -118.83 & Long < -117.7) %>% 
  filter(!is.na(Lat)) %>% 
  rename(
    chla = `Chl a (ug/L)`,
    da = `DA (ng/mL)`,
    pn = `PN cells (cells/L)`,
    temp = Temp, 
    sal = Salinity, 
    nitrogen = `NO2+NO3`
  ) %>% 
  st_as_sf(., coords = c('Long', 'Lat'), crs = prj)

# newport and santa monica ts
tsdat <- wqdat %>% 
  select(Year, Month, `Full Date`, `Project ID`, `Station ID`, Depth, `Depth Category`, `Lat`, `Long`, `DA (ng/mL)`, `PN cells (cells/L)`, `Chl a (ug/L)`, Temp, Salinity, `NO2+NO3`) %>% 
  filter(grepl('^Santa\\sMonica\\sPier|^Newport', `Station ID`)) %>% 
  rename(
    chla = `Chl a (ug/L)`,
    da = `DA (ng/mL)`,
    pn = `PN cells (cells/L)`,
    temp = Temp, 
    sal = Salinity, 
    nitrogen = `NO2+NO3`
  ) %>% 
  filter(!is.na(Lat)) %>% 
  st_as_sf(., coords = c('Long', 'Lat'), crs = prj)
```

## Plots

Locations with lat/lon, summarized by numbers of years sampled:
```{r}
wqdatgeosum <- wqdat %>% 
  filter(!is.na(Lat)) %>%
  group_by(`Station ID`) %>% 
  nest %>% 
  mutate(
    nyrs = purrr::map(data, function(x) length(unique(x$Year))),
    Lat = purrr::map(data, function(x) mean(x$Lat, na.rm = T)), 
    Long = purrr::map(data, function(x) mean(x$Long, na.rm = T))
  ) %>% 
  dplyr::select(-data) %>% 
  unnest %>% 
  st_as_sf(., coords = c('Long', 'Lat'), crs = prj)

mapview(wqdatgeosum, zcol = 'nyrs', layer.name = "Years sampled")
```

Caron dataset:
```{r}
mapview(jsdat)
```

Time series data, Newport Beach and Santa Monica Pier:
```{r, eval = F}
toplo <- tsdat %>% 
  st_set_geometry(NULL) %>% 
  dplyr::select(`Full Date`, `Station ID`, da, pn, chla) %>%
  mutate(
    da = 1000*da, 
    da.edit = ifelse(da > 400, 401, da),
    text.da = ifelse(da > 400, 'Y', 'N'),
    zero.da = ifelse(da > 0, 'N', 'Y')
  )
dalabs <- filter(toplo, text.da == 'Y')

# point scales
scls <- c(1, 12)

leglab <- expression(paste('Domoic acid (ng ', L^-1, ')'))
brks <- c(0, 50, 100, 150, 200, 400)
labs <- c('>0-50', '50-100', '100-150', '150-200', '200-400', '>400')

p1 <- ggplot(toplo, aes(x = `Full Date`, y = `Station ID`)) + 
  geom_point(aes(size = da.edit, shape = zero.da, colour = da.edit), alpha = 0.8) + 
  geom_label(data = dalabs, aes(label = floor(da)), size = 4, alpha = 0.6) +
  theme_bw(base_family = 'serif') + 
  theme(axis.title = element_blank()) +
    scale_size_continuous(leglab,
    breaks = brks,
    range = scls, 
    labels = labs
    ) + 
  scale_colour_gradientn(leglab, 
    element_text('test'),
    colours = c('gray50', 'grey15'),
    breaks = brks,
    labels = labs
    ) + 
  scale_shape_manual(values = c(16, 1), guide = F) +
  guides(colour = guide_legend(), size = guide_legend()) +
  ggtitle('(a) Domoic Acid (DA)') 

p2 <- ggplot(toplo, aes(x = date, y = `Station ID`, size = pn)) + 
  geom_point(alpha = 0.6) + 
  scale_size('Psuedo-nitzschia (cells/L)', trans = 'log10') + 
  theme_bw(base_family = 'serif') + 
  theme(axis.title = element_blank())

p3 <- ggplot(toplo, aes(x = date, y = `Station ID`, size = chla)) + 
  geom_point(alpha = 0.6) + 
  scale_size('Chl-a (ug/L)', trans = 'log10', range = c(0.2, 2)) + 
  theme_bw(base_family = 'serif') + 
  theme(axis.title = element_blank())


p1 + p2 + p3 + plot_layout(ncol = 1)
```

