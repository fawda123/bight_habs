---
output: 
  bookdown::html_document2:
    code_folding: hide
---

# Exploration of DA Bight dataset {.tabset}

```{r message = F, warning = F, results = 'hide'}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, fig.path = 'figs/', dev.args = list(family = 'serif'))

library(tidyverse)
library(sf)
library(mapview)
library(patchwork)
library(lubridate)
library(ggrepel)
library(condprob2)
library(here)
library(gridExtra)
library(grid)
library(FactoMineR)
library(missMDA)
library(vegan)
library(ggord)
library(scales)

prj <- 4326 # wgs84

source('R/funcs.R')

pbase <- theme_bw(base_family = 'serif', base_size = 14) +
  theme(
    strip.background = element_blank(), 
    legend.position = 'top', 
    legend.title = element_blank()
  )

data(tsdat)

# rename some stuff
tsdat <- tsdat %>% 
  filter(!location %in% 'Monterey Wharf') %>% 
  rename(
    chla = `Chlorophyll (mg/m3)`,
    da = `Domoic Acid (ng/mL)`,
    pntot = `Pseudo-nitzschia Total Cells (cells/L)`,
    pndel = `Pseudo-nitzschia delicatissima group (cells/L)`,
    pnser = `Pseudo-nitzschia seriata group (cells/L)`,
    temp = `Water Temperature (C)`, 
    phosphorus = `Phosphate (uM)`,
    silicate = `Silicate (uM)`, 
    nitrate = `Nitrate (uM)`,
    nitrite = `Nitrite (uM)`,
    ammonia = `Ammonia (uM)`,
    depth = `depth (m)`
  ) 

# all wq data as sf
tsdatgeo <- tsdat %>% 
  select(location, Long, Lat) %>% 
  unique %>% 
  st_as_sf(., coords = c('Long', 'Lat'), crs = prj)


```

## Conceptual model

```{r, out.height="70%"}
knitr::include_graphics(here('figs', 'model.png'))
```

## LTM time series

Locations: 

```{r, out.width = "100%"}
mapview(tsdatgeo, homebutton = F, layer.name = F)
```

Time series (from north to south):

```{r, fig.height = 8, fig.width = 12}
toplo <- tsdat %>% 
  dplyr::select(date, location, Lat, da, pntot, chla) %>%
  mutate(
    da = 1000*da, # from ng/mL to mg/L
    da.edit = ifelse(da > 400, 401, da),
    text.da = ifelse(da > 400, 'Y', 'N'),
    zero.da = ifelse(da > 0, 'N', 'Y'), 
    pn = pntot / 1000, # cell/L to cells/ml
    pn.edit = ifelse(pn > 400, 401, pn),
    text.pn = ifelse(pn > 400, 'Y', 'N'),
    zero.pn = ifelse(pn > 0, 'N', 'Y'),
    chla.edit = ifelse(chla > 20, 21, chla),
    text.chla = ifelse(chla > 20, 'Y', 'N'),
    zero.chla = ifelse(chla > 0, 'N', 'Y')
  )
dalabs <- filter(toplo, text.da == 'Y')
pnlabs <- filter(toplo, text.pn == 'Y')
chlalabs <- filter(toplo, text.chla == 'Y')

# point scales
scls <- c(1, 8)

# color ramp
cols <- c('lightgreen', 'tomato1') #c('gray50', 'grey15')

leglab <- expression(paste('conc. (mg ', L^-1, ')'))
brks <- c(0, 50, 100, 150, 200, 400)
labs <- c('>0-50', '50-100', '100-150', '150-200', '200-400', '>400')
p1 <- ggplot(toplo, aes(x = date, y = reorder(location, Lat))) + 
  geom_point(aes(size = da.edit, shape = zero.da, colour = da.edit), alpha = 0.8) + 
  # geom_label_repel(data = dalabs, aes(label = floor(da)),
  #   box.padding = 1,
  #   point.padding = NA,
  #   size = 4, alpha = 0.7,
  #   min.segment.length = 0,
  #   colour = 'tomato1'
  #   ) +
  theme_bw(base_family = 'serif') + 
  theme(axis.title = element_blank()) +
  scale_size_continuous(leglab,
    breaks = brks,
    range = scls, 
    labels = labs
    ) + 
  scale_colour_gradientn(leglab, 
    element_text('test'),
    colours = cols,
    breaks = brks,
    labels = labs
    ) + 
  scale_shape_manual(values = c(16, 1), guide = F) +
  guides(colour = guide_legend(), size = guide_legend()) +
  ggtitle('(a) Domoic Acid (DA)') 

leglab <- expression(paste('cells (', mL^-1, ')'))
brks <- c(0, 50, 100, 150, 200, 400)
labs <- c('>0-50', '50-100', '100-150', '150-200', '200-400', '>400')
p2 <- ggplot(toplo, aes(x = date, y = reorder(location, Lat))) + 
  geom_point(aes(size = pn.edit, shape = zero.pn, colour = pn.edit), alpha = 0.8) + 
  # geom_label_repel(data = pnlabs, aes(label = floor(pn)), 
  #   box.padding = 1,
  #   point.padding = NA, 
  #   size = 4, alpha = 0.7, 
  #   min.segment.length = 0,
  #   colour = 'tomato1'
  #   ) +
  theme_bw(base_family = 'serif') + 
  theme(axis.title = element_blank()) +
    scale_size_continuous(leglab,
    breaks = brks,
    range = scls, 
    labels = labs
    ) + 
  scale_colour_gradientn(leglab, 
    element_text('test'),
    colours = cols,
    breaks = brks,
    labels = labs
    ) + 
  scale_shape_manual(values = c(16, 1), guide = F) +
  guides(colour = guide_legend(), size = guide_legend()) +
  ggtitle('(b) Pseudo-nitzschia') 

leglab <- expression(paste('conc. (ug ', L^-1, ')'))
brks <- c(0, 1, 5, 10, 15, 20)
labs <- c('>0-1', '1-5', '5-10', '10-15', '15-20', '>20')
p3 <- ggplot(toplo, aes(x = date, y = reorder(location, Lat))) + 
  geom_point(aes(size = chla.edit, shape = zero.chla, colour = chla.edit), alpha = 0.8) + 
  # geom_label_repel(data = chlalabs, aes(label = floor(chla)), 
  #   box.padding = 1,
  #   point.padding = NA, 
  #   size = 4, alpha = 0.7, 
  #   min.segment.length = 0,
  #   colour = 'tomato1'
  #   ) +
  theme_bw(base_family = 'serif') + 
  theme(axis.title = element_blank()) +
    scale_size_continuous(leglab,
    breaks = brks,
    range = scls, 
    labels = labs
    ) + 
  scale_colour_gradientn(leglab, 
    element_text('test'),
    colours = cols,
    breaks = brks,
    labels = labs
    ) + 
  scale_shape_manual(values = c(16, 1), guide = F) +
  guides(colour = guide_legend(), size = guide_legend()) +
  ggtitle('(c) Chlorophyll-a') 

p1 + p2 + p3 + plot_layout(ncol = 1)
```

## Conditional probability analyses

Scatterplots of chl vs DA, psuedo nitzschia concentration:
```{r, fig.height = 8, fig.width = 8}

toplo1 <- tsdat %>%
  filter(!is.na(chla) & !is.na(da))

ylb <- expression(paste('Domoic acid conc. (ng  ', L^-1, ')'))

p1 <- ggplot(toplo1, aes(x = chla, y = da)) +
  geom_point(alpha = 0.7) +
  theme_bw(base_family = 'serif') +
  theme(strip.background = element_blank()) +
  facet_wrap(~reorder(location, -Lat), ncol = 1) +
  geom_smooth(method = 'lm', colour = 'lightblue') +
  scale_x_log10(expression(paste('Chl-a (ug ', L^-1, ')'))) +
  scale_y_log10(ylb)

toplo2 <- tsdat %>%
  filter(!is.na(chla) & !is.na(pntot))

ylb <- expression(paste('Pseudonitzchia cells ( ', L^-1, ')'))

p2 <- ggplot(toplo2, aes(x = chla, y = pntot)) +
  geom_point(alpha = 0.7) +
  theme_bw(base_family = 'serif') +
  theme(strip.background = element_blank()) +
  facet_wrap(~reorder(location, -Lat), ncol = 1) +
  geom_smooth(method = 'lm', colour = 'lightblue') +
  scale_x_log10(expression(paste('Chl-a (ug ', L^-1, ')'))) +
  scale_y_log10(ylb)

p1 + p2 + plot_layout(ncol = 2)
```

Logistic regression of likelihood of seeing DA with chl, all Bight stations:
```{r, fig.height = 8, fig.width = 8}

toplo1 <- tsdat %>%
  mutate(
    dapa = ifelse(da > 0, 1, 0)
  ) %>%
  filter(!is.na(chla) & !is.na(da))

leglab <- expression(paste('Domoic acid\nconc. (ng ', L^-1, ')'))

p1 <- ggplot(toplo1, aes(x = chla, y = dapa)) +
  geom_point(aes(size = da), alpha = 0.7) +
  theme_bw(base_family = 'serif') +
  theme(
    strip.background = element_blank(),
    legend.position = 'top'
    ) +
  facet_wrap(~reorder(location, -Lat), ncol = 1) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), colour = 'lightblue') +
  scale_x_log10(expression(paste('Chl-a (ug ', L^-1, ')'))) +
  ylab('Likelihood of domoic acid') +
  scale_size_continuous(leglab, range = c(1, 8))

toplo2 <- tsdat %>%
  filter(!is.na(chla) & !is.na(pntot)) %>%
  mutate(
    pnhilo = ifelse(pntot > 100, 1, 0)
  )

leglab <- expression(paste('Cells (', L^-1, ')'))

p2 <- ggplot(toplo2, aes(x = chla, y = pnhilo)) +
  geom_point(aes(size = pntot), alpha = 0.7) +
  theme_bw(base_family = 'serif') +
  theme(
    strip.background = element_blank(),
    legend.position = 'top'
    ) +
  facet_wrap(~reorder(location, -Lat), ncol = 1) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), colour = 'lightblue') +
  scale_x_log10(expression(paste('Chl-a (ug ', L^-1, ')'))) +
  scale_y_continuous(expression(paste('Likelihood of high cell concentration (> 100    ', L^-1, ')'))) +
  scale_size_continuous(leglab, range = c(1, 8))

p1 + p2 + plot_layout(ncol = 2)
```

Conditional probability plots, same response as above but using non-linear method.  The first set shows the likelihood of observing domoic acid or cell concentration greater than 100 L$^{-1}$ at concentrations of chlorophyll less than or equal to those on the x-axis.
```{r, fig.height = 8, fig.width = 8}

locs <- reorder(tsdat$location, -tsdat$Lat) %>% levels
ends <- c('da', 'pntot')
thrs <- c(0, 100)
labs <- c('Likelihood of Domoic acid', expression(paste('Likelihood of high cell concentration (> 100    ', L^-1, ')')))
names(thrs) <- ends
names(labs) <- ends
                                                
plos <- crossing(locs, ends) %>% 
  group_by(locs, ends) %>% 
  mutate(
    plo = pmap(list(locs, ends), function(locs, ends){

      # inputs
      xval <- tsdat$chla[tsdat$location %in% locs]
      yval <- tsdat[tsdat$location %in% locs, ] %>% pull({ends})
      thrs <- thrs[ends]
      ylbs <- labs[ends]
      
      # cond. prob results
      res <- condprob(xval, yval, thrs, 'gt', 'lte', T, R = 100)
      
      # plots
      p <- plot(res) +
        scale_x_log10() +
        theme_bw(base_family = 'serif') +
        theme(
          axis.title = element_blank(), 
          plot.title = element_text(hjust = 0.5, size= 8)
          ) +
        ggtitle(locs)

      return(p)
      
    })
  ) %>% 
  pull(plo)

# text par
gpval <- gpar(fontfamily = 'serif')

# unholy grid arrange
grid.arrange(
  arrangeGrob(
    left = textGrob(labs[1], rot = 90, gp = gpval), 
    plos[[1]], plos[[3]], plos[[5]], plos[[7]], plos[[9]], plos[[11]], plos[[13]], ncol = 1
    ),
  arrangeGrob(
    left = textGrob(labs[2], rot = 90, gp = gpval),
    plos[[2]], plos[[4]], plos[[6]], plos[[8]], plos[[10]], plos[[12]], plos[[14]], ncol = 1
  ),
  bottom = textGrob(expression(paste('Chl-a (ug ', L^-1, '), less than or equal to')), gp = gpval), 
  ncol = 2
)
```

The second set shows the likelihood of observing domoic acid or cell concentration greater than 10 L$^{-1}$ at concentrations of chlorophyll greater than or equal to those on the x-axis.
```{r, fig.height = 8, fig.width = 8}
locs <- reorder(tsdat$location, -tsdat$Lat) %>% levels
ends <- c('da', 'pntot')
thrs <- c(0, 100)
labs <- c('Likelihood of Domoic acid', expression(paste('Likelihood of high cell concentration (> 100    ', L^-1, ')')))
names(thrs) <- ends
names(labs) <- ends
                                                
plos <- crossing(locs, ends) %>% 
  group_by(locs, ends) %>% 
  mutate(
    plo = pmap(list(locs, ends), function(locs, ends){

      # inputs
      xval <- tsdat$chla[tsdat$location %in% locs]
      yval <- tsdat[tsdat$location %in% locs, ] %>% pull({ends})
      thrs <- thrs[ends]
      ylbs <- labs[ends]
      
      # cond. prob results
      res <- condprob(xval, yval, thrs, 'gt', 'gte', T, R = 100)
      
      # plots
      p <- plot(res) +
        scale_x_log10() +
        theme_bw(base_family = 'serif') +
        theme(
          axis.title = element_blank(), 
          plot.title = element_text(hjust = 0.5, size= 10)
          ) +
        ggtitle(locs)

      return(p)
      
    })
  ) %>% 
  pull(plo)

# text par
gpval <- gpar(fontfamily = 'serif')

# unholy grid arrange
grid.arrange(
  arrangeGrob(
    left = textGrob(labs[1], rot = 90, gp = gpval), 
    plos[[1]], plos[[3]], plos[[5]], plos[[7]], plos[[9]], plos[[11]], plos[[13]], ncol = 1
    ),
  arrangeGrob(
    left = textGrob(labs[2], rot = 90, gp = gpval),
    plos[[2]], plos[[4]], plos[[6]], plos[[8]], plos[[10]], plos[[12]], plos[[14]], ncol = 1
  ),
  bottom = textGrob(expression(paste('Chl-a (ug ', L^-1, '), greater than or equal to')), gp = gpval), 
  ncol = 2
)
```

## Multivariate analyses {.tabset .tabset-pills}

### PCA

```{r, out.height = "100%", fig.height = 17, fig.width = 6, fig.align="center"}

mythm2 <- theme_bw(base_family = 'serif') +
  theme(
    strip.background = element_blank(), 
    text = element_text(family = 'serif', size = 12)
  ) 

# all dates
tomodall <- tsdat %>% 
  mutate(
    temp = ifelse(temp == 0, NA, temp),
    nitrate = ifelse(nitrate < 0, 0, nitrate)
    ) %>% 
  select(ammonia, chla, da, nitrate, nitrite, phosphorus, pntot, silicate, temp) %>% 
  mutate_at(vars(-temp), decostand, method = 'log', MARGIN = 2 , logbase = 10, na.rm = T) %>%
  as.data.frame %>% 
  imputePCA %>% 
  .$completeObs
  
pcamod <- PCA(tomodall, scale.unit = T, graph = F)

p1 <- ggord(pcamod, size = tsdat$Lat, vec_ext = 6, alpha = 0.5, txt = 4, arrow = 0.2, repel = F, coord_fix = F, labcol = 'tomato1', veccol = 'tomato1', sizelab = 'Latitude') + 
  mythm2 +
  ggtitle('All dates') + 
  scale_size(range = c(0.3, 1.5))


pcamodgrp <- tsdat %>% 
  group_by(qrt) %>% 
  nest %>% 
  mutate(
    plo = purrr::pmap(list(qrt, data), function(qrt, data){
      
      tomod <- data %>% 
        mutate(
          temp = ifelse(temp == 0, NA, temp),
          nitrate = ifelse(nitrate < 0, 0, nitrate)
          ) %>% 
        select(ammonia, chla, da, nitrate, nitrite, phosphorus, pntot, silicate, temp) %>% 
        mutate_at(vars(-temp), decostand, method = 'log', MARGIN = 2 , logbase = 10, na.rm = T) %>% 
        as.data.frame %>% 
        imputePCA %>% 
        .$completeObs
  
      pcamod <- PCA(tomod, scale.unit = T, graph = F)

      p <- ggord(pcamod, vec_ext = 6, alpha = 0.5, size = data$Lat, txt = 4, arrow = 0.2, repel = F, coord_fix = F, labcol = 'tomato1', veccol = 'tomato1', sizelab = 'Latitude') + 
        mythm2 +
        ggtitle(qrt)+ 
        scale_size(range = c(0.3, 1.5))
      
      return(p)
      
    })
  ) %>% 
  pull(plo)

grid.arrange(
  p1, pcamodgrp[[3]], pcamodgrp[[4]], pcamodgrp[[1]], pcamodgrp[[2]], 
  ncol = 1
)

```
